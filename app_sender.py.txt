import streamlit as st
import pandas as pd
import io
import requests
import json
import numpy as np
import re

# --- å›ºå®šè¨­å®š ---
TARGET_SHEET_NAME = "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ" 
# ---

st.set_page_config(page_title="Excel to Sheet Sender", layout="centered")
st.title("ğŸ“¤ Excel â†’ ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘ã‚·ãƒ¼ãƒˆã¸ãƒãƒƒãƒ”ãƒ³ã‚°æ›¸ãè¾¼ã¿")
st.success("âœ… Web App URLã®å¤‰æ›´ã¯ä¸è¦ã«ãªã‚Šã¾ã—ãŸï¼")

# --- è¨­å®šé …ç›® ---
with st.expander("GAS Web App URL (ä¸€åº¦ã ã‘è¨­å®š)", expanded=False):
    GAS_WEB_APP_URL = st.text_input("GAS ãƒ«ãƒ¼ã‚¿ãƒ¼ Web App URL", "ã“ã“ã«ä¸€åº¦ã ã‘ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸURLã‚’è²¼ã‚Šä»˜ã‘")

with st.expander("ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±", expanded=True):
    # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã¯ã€URLã® d/ ã®æ¬¡ã‹ã‚‰ /edit ã¾ã§ ã®éƒ¨åˆ†ã§ã™ã€‚
    SPREADSHEET_ID_INPUT = st.text_input("ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID", "ã‚³ãƒ”ãƒ¼ã—ãŸã‚·ãƒ¼ãƒˆã®URLã‚’è²¼ã‚Šä»˜ã‘")
    st.info(f"æ›¸ãè¾¼ã¿å…ˆã‚·ãƒ¼ãƒˆ: {TARGET_SHEET_NAME}")


uploaded_file = st.file_uploader("Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—", type=["xlsx", "xls"])

if uploaded_file and GAS_WEB_APP_URL and SPREADSHEET_ID_INPUT and GAS_WEB_APP_URL != "ã“ã“ã«ä¸€åº¦ã ã‘ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸURLã‚’è²¼ã‚Šä»˜ã‘":
    if st.button(f"ğŸš€ ã€{TARGET_SHEET_NAME}ã€‘ã‚·ãƒ¼ãƒˆã¸ãƒãƒƒãƒ”ãƒ³ã‚°æ›¸ãè¾¼ã¿ã‚’å®Ÿè¡Œ"):
        
        # IDè‡ªå‹•æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ï¼ˆURLå…¨ä½“ãŒè²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã¦ã‚‚IDã‚’æŠ½å‡ºï¼‰
        id_input = SPREADSHEET_ID_INPUT.strip()
        
        # URLå…¨ä½“ (https://docs.google.com/spreadsheets/d/ID/edit...) ã‹ã‚‰IDã‚’æŠ½å‡º
        match = re.search(r'/d/([a-zA-Z0-9_-]+)/', id_input)
        if match:
            clean_spreadsheet_id = match.group(1)
        # IDã®ã¿ã€ã¾ãŸã¯IDã‚’å«ã‚€çŸ­ã„æ–‡å­—åˆ—ã®å ´åˆ
        else:
            clean_spreadsheet_id = id_input.split('/')[0].split('#')[0].split('?')[0]
        
        # æœ€çµ‚çš„ãªIDã®æ¤œè¨¼ï¼ˆIDã¯é€šå¸¸30æ–‡å­—ä»¥ä¸Šï¼‰
        if len(clean_spreadsheet_id) < 30:
            st.error("ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒçŸ­ã™ãã¾ã™ã€‚æ­£ã—ã„IDã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚")
            st.stop()
            
        try:
            # 1. Excelã‚’èª­ã¿è¾¼ã¿ 
            df = pd.read_excel(uploaded_file, header=None, sheet_name=0) 
            raw_data = df.replace({np.nan: None}).values.tolist()

            # 2. ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã®å®šç¾© (å¤‰æ›´ãªã—)
            mappings = []
            mappings.append({"target": "G1", "data": [[raw_data[1][6]]]})
            mappings.append({"target": "O1", "data": [[raw_data[1][14]]]})
            mappings.append({"target": "B4", "data": [[raw_data[4][1]]]})
            mappings.append({"target": "F4", "data": [[raw_data[4][5]]]})
            mappings.append({"target": "C5", "data": [row[2:15] for row in raw_data[5:23]]})
            mappings.append({"target": "C30", "data": [row[2:15] for row in raw_data[34:52]]})
            mappings.append({"target": "C55", "data": [row[2:15] for row in raw_data[64:82]]})
            mappings.append({"target": "C80", "data": [row[2:15] for row in raw_data[94:112]]})
            mappings.append({"target": "C105", "data": [row[2:15] for row in raw_data[123:141]]})
            mappings.append({"target": "C130", "data": [row[2:15] for row in raw_data[153:171]]})

            # 3. GAS Web App ã«ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ (JSON) ã§é€ä¿¡
            payload = {
                "spreadsheetId": clean_spreadsheet_id,
                "sheetName": TARGET_SHEET_NAME,
                "mappings": mappings
            }
            
            st.info(f"ğŸ”„ ID: {clean_spreadsheet_id} ã® {TARGET_SHEET_NAME} ã‚·ãƒ¼ãƒˆã¸ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­...")
            
            headers = {'Content-Type': 'application/json; charset=utf-8'}
            response = requests.post(GAS_WEB_APP_URL, data=json.dumps(payload).encode('utf-8'), headers=headers)
            
            # 4. çµæœã®ç¢ºèª
            if response.status_code == 200 and "Success" in response.text:
                st.success("âœ… æ›¸ãè¾¼ã¿æˆåŠŸï¼ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæŒ‡å®šç¯„å›²ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¾ã—ãŸã€‚")
                st.caption("GASã‹ã‚‰ã®å¿œç­”: {}".format(response.text))
            else:
                st.error("âŒ æ›¸ãè¾¼ã¿å¤±æ•—ã€‚GASã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
                
                error_message = f"\\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: {response.status_code}\\nå¿œç­”: {response.content.decode('utf-8')}"
                st.code(error_message)

        except Exception as e:
            st.error("è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼è©³ç´°: {}".format(e))
            st.warning("Excelã®å½¢å¼ã€GASãƒ«ãƒ¼ã‚¿ãƒ¼ã®URLã€ã¾ãŸã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")